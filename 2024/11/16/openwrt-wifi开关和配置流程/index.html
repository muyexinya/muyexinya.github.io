<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>openwrt_wifi开关和配置流程 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="openwrt wifi开关和配置流程简介本文章介绍openwrt中wifi的初始化和配置流程。 生成&#x2F;etc&#x2F;config&#x2F;wireless文件在wifi驱动加载后，内核会推送ieee80211 ADD的uevent，触发执行&#x2F;etc&#x2F;hotplug.d&#x2F;ieee80211&#x2F;10-wifi-detect脚本。之后执行&#x2F;sbin&#x2F;wifi config。 123456">
<meta property="og:type" content="article">
<meta property="og:title" content="openwrt_wifi开关和配置流程">
<meta property="og:url" content="https://muyexinya.github.io/2024/11/16/openwrt-wifi%E5%BC%80%E5%85%B3%E5%92%8C%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="openwrt wifi开关和配置流程简介本文章介绍openwrt中wifi的初始化和配置流程。 生成&#x2F;etc&#x2F;config&#x2F;wireless文件在wifi驱动加载后，内核会推送ieee80211 ADD的uevent，触发执行&#x2F;etc&#x2F;hotplug.d&#x2F;ieee80211&#x2F;10-wifi-detect脚本。之后执行&#x2F;sbin&#x2F;wifi config。 123456">
<meta property="og:locale">
<meta property="article:published_time" content="2024-11-16T07:02:15.000Z">
<meta property="article:modified_time" content="2024-12-03T14:28:42.787Z">
<meta property="article:author" content="muyexinya@163.com">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Suche"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://muyexinya.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-openwrt-wifi开关和配置流程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/11/16/openwrt-wifi%E5%BC%80%E5%85%B3%E5%92%8C%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2024-11-16T07:02:15.000Z" itemprop="datePublished">2024-11-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      openwrt_wifi开关和配置流程
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="openwrt-wifi开关和配置流程"><a href="#openwrt-wifi开关和配置流程" class="headerlink" title="openwrt wifi开关和配置流程"></a>openwrt wifi开关和配置流程</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>本文章介绍openwrt中wifi的初始化和配置流程。</p>
<h2 id="生成-etc-config-wireless文件"><a href="#生成-etc-config-wireless文件" class="headerlink" title="生成&#x2F;etc&#x2F;config&#x2F;wireless文件"></a>生成&#x2F;etc&#x2F;config&#x2F;wireless文件</h2><p>在wifi驱动加载后，内核会推送ieee80211 ADD的uevent，触发执行<code>/etc/hotplug.d/ieee80211/10-wifi-detect</code>脚本。之后执行<code>/sbin/wifi config</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">[ &quot;$&#123;ACTION&#125;&quot; = &quot;add&quot; ] &amp;&amp; &#123;</span><br><span class="line">        /sbin/wifi config</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>/sbin/wifi</code>是一个shell脚本，<code>/sbin/wifi config</code>对应的代码是<code>wifi_config()</code>，在<code>wifi_config()</code>中创建了<code>/etc/config/wireless</code>文件并调用了<code>detect_mac80211</code>。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wifi_config() &#123;</span><br><span class="line">        [ ! -f /etc/config/wireless ] &amp;&amp; touch /etc/config/wireless</span><br><span class="line"></span><br><span class="line">        for driver in $DRIVERS; do (</span><br><span class="line">                if eval &quot;type detect_$driver&quot; 2&gt;/dev/null &gt;/dev/null; then</span><br><span class="line">                        eval &quot;detect_$driver&quot; || echo &quot;$driver: Detect failed&quot; &gt;&amp;2</span><br><span class="line">                else</span><br><span class="line">                        echo &quot;$driver: Hardware detection not supported&quot; &gt;&amp;2</span><br><span class="line">                fi</span><br><span class="line">        ); done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>函数<code>detect_mac80211()</code>位于脚本<code>/lib/wifi/mac80211.sh</code> ,该写入了默认wifi ap配置到<code>/etc/config/wireless</code>中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">detect_mac80211() &#123;</span><br><span class="line">	devidx=0</span><br><span class="line">	config_load wireless</span><br><span class="line">	config_foreach check_devidx wifi-device</span><br><span class="line"></span><br><span class="line">	json_load_file /etc/board.json</span><br><span class="line"></span><br><span class="line">	for _dev in /sys/class/ieee80211/*; do</span><br><span class="line">		[ -e &quot;$_dev&quot; ] || continue</span><br><span class="line"><span class="meta prompt_">		#</span><span class="language-bash">提取/*/*/*/dev中的dev。</span></span><br><span class="line">		dev=&quot;$&#123;_dev##*/&#125;&quot;</span><br><span class="line"></span><br><span class="line">		mode_band=&quot;&quot;</span><br><span class="line">		channel=&quot;&quot;</span><br><span class="line">		htmode=&quot;&quot;</span><br><span class="line">		ht_capab=&quot;&quot;</span><br><span class="line"></span><br><span class="line">		get_band_defaults &quot;$dev&quot;</span><br><span class="line"></span><br><span class="line">		path=&quot;$(iwinfo nl80211 path &quot;$dev&quot;)&quot;</span><br><span class="line">		macaddr=&quot;$(cat /sys/class/ieee80211/$&#123;dev&#125;/macaddress)&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">		# </span><span class="language-bash">work around phy rename related race condition</span></span><br><span class="line">		[ -n &quot;$path&quot; -o -n &quot;$macaddr&quot; ] || continue</span><br><span class="line"></span><br><span class="line">		board_dev=</span><br><span class="line">		fallback_board_dev=</span><br><span class="line">		json_for_each_item check_board_phy wlan</span><br><span class="line">		[ -n &quot;$board_dev&quot; ] || board_dev=&quot;$fallback_board_dev&quot;</span><br><span class="line">		[ -n &quot;$board_dev&quot; ] &amp;&amp; dev=&quot;$board_dev&quot;</span><br><span class="line"></span><br><span class="line">		found=</span><br><span class="line">		config_foreach check_mac80211_device wifi-device &quot;$path&quot; &quot;$macaddr&quot;</span><br><span class="line">		[ -n &quot;$found&quot; ] &amp;&amp; continue</span><br><span class="line"></span><br><span class="line">		name=&quot;radio$&#123;devidx&#125;&quot;</span><br><span class="line">		devidx=$(($devidx + 1))</span><br><span class="line">		case &quot;$dev&quot; in</span><br><span class="line">			phy*)</span><br><span class="line">				if [ -n &quot;$path&quot; ]; then</span><br><span class="line">					dev_id=&quot;set wireless.$&#123;name&#125;.path=&#x27;$path&#x27;&quot;</span><br><span class="line">				else</span><br><span class="line">					dev_id=&quot;set wireless.$&#123;name&#125;.macaddr=&#x27;$macaddr&#x27;&quot;</span><br><span class="line">				fi</span><br><span class="line">				;;</span><br><span class="line">			*)</span><br><span class="line">				dev_id=&quot;set wireless.$&#123;name&#125;.phy=&#x27;$dev&#x27;&quot;</span><br><span class="line">				;;</span><br><span class="line">		esac</span><br><span class="line"></span><br><span class="line">		uci -q batch &lt;&lt;-EOF</span><br><span class="line">			set wireless.$&#123;name&#125;=wifi-device</span><br><span class="line">			set wireless.$&#123;name&#125;.type=mac80211</span><br><span class="line"><span class="meta prompt_">			$</span><span class="language-bash">&#123;dev_id&#125;</span></span><br><span class="line">			set wireless.$&#123;name&#125;.channel=$&#123;channel&#125;</span><br><span class="line">			set wireless.$&#123;name&#125;.band=$&#123;mode_band&#125;</span><br><span class="line">			set wireless.$&#123;name&#125;.htmode=$htmode</span><br><span class="line">			set wireless.$&#123;name&#125;.disabled=1</span><br><span class="line"></span><br><span class="line">			set wireless.default_$&#123;name&#125;=wifi-iface</span><br><span class="line">			set wireless.default_$&#123;name&#125;.device=$&#123;name&#125;</span><br><span class="line">			set wireless.default_$&#123;name&#125;.network=lan</span><br><span class="line">			set wireless.default_$&#123;name&#125;.mode=ap</span><br><span class="line">			set wireless.default_$&#123;name&#125;.ssid=OpenWrt</span><br><span class="line">			set wireless.default_$&#123;name&#125;.encryption=none</span><br><span class="line">EOF</span><br><span class="line">		uci -q commit wireless</span><br><span class="line">	done</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="netifd初始化wireless的流程"><a href="#netifd初始化wireless的流程" class="headerlink" title="netifd初始化wireless的流程"></a>netifd初始化wireless的流程</h2><p>netifd初始化wireless的流程如下，</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">main()</span><br><span class="line">	-&gt;wireless_init()</span><br><span class="line">		-&gt;wireless_add_handler()</span><br><span class="line">    -&gt;config_init_all()</span><br><span class="line">    	-&gt;config_init_package(<span class="string">&quot;wireless&quot;</span>)</span><br><span class="line">    	-&gt;wireless_start_pending(<span class="number">0</span>)</span><br><span class="line">    		-&gt;__wireless_start_pending()</span><br><span class="line">    			-&gt;__wireless_device_set_up(wdev, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p><code>wireless_init</code>相关代码如下,该函数主要是遍历&#x2F;lib&#x2F;netifd&#x2F;wireless目录下的*.sh中 函数。并执行<code>./*.sh &#39;&#39; dump</code>命令，注册sh脚本中的handler。</p>
<figure class="highlight v"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> wireless_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	vlist_init(&amp;wireless_devices, avl_strcmp, wdev_update);</span><br><span class="line">	wireless_devices<span class="variable">.keep_old</span> = true;</span><br><span class="line">	wireless_devices<span class="variable">.no_delete</span> = true;</span><br><span class="line"></span><br><span class="line">	avl_init(&amp;wireless_drivers, avl_strcmp, false, NULL);</span><br><span class="line">	drv_fd = netifd_open_subdir(<span class="string">&quot;wireless&quot;</span>); <span class="comment">// 打开目录/lib/netifd/wireless,该目录下有mac80211.sh。</span></span><br><span class="line">	<span class="keyword">if</span> (drv_fd &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	netifd_init_script_handlers(drv_fd, wireless_add_handler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> netifd_init_script_handlers(<span class="keyword">int</span> dir_fd, script_dump_cb cb)</span><br><span class="line">&#123;</span><br><span class="line">	glob_t g;</span><br><span class="line">	<span class="keyword">int</span> prev_fd;</span><br><span class="line">	size_t i;</span><br><span class="line"></span><br><span class="line">	prev_fd = netifd_dir_push(dir_fd);</span><br><span class="line">    <span class="comment">// 遍历目录下的*.sh文件</span></span><br><span class="line">	<span class="keyword">if</span> (glob(<span class="string">&quot;./*.sh&quot;</span>, <span class="number">0</span>, NULL, &amp;g)) &#123;</span><br><span class="line">		netifd_dir_pop(prev_fd);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; g<span class="variable">.gl_pathc</span>; i++)</span><br><span class="line">		netifd_parse_script_handler(g<span class="variable">.gl_pathv</span>[i], cb);</span><br><span class="line">	netifd_dir_pop(prev_fd);</span><br><span class="line"></span><br><span class="line">	globfree(&amp;g);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">netifd_parse_script_handler(<span class="keyword">const</span> char *name, script_dump_cb cb)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">struct</span> json_tokener *tok = NULL;</span><br><span class="line">	json_object *obj;</span><br><span class="line">	<span class="keyword">static</span> char <span class="keyword">buf</span>[<span class="number">512</span>];</span><br><span class="line">	char *start, *cmd;</span><br><span class="line">	FILE *f;</span><br><span class="line">	<span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line">#define DUMP_SUFFIX	<span class="string">&quot; &#x27;&#x27; dump&quot;</span></span><br><span class="line"></span><br><span class="line">	cmd = alloca(strlen(name) + <span class="number">1</span> + sizeof(DUMP_SUFFIX));</span><br><span class="line">	sprintf(cmd, <span class="string">&quot;%s&quot;</span> DUMP_SUFFIX, name);</span><br><span class="line"><span class="comment">// 执行命令mac80211.sh &#x27;&#x27; dump</span></span><br><span class="line">	f = popen(cmd, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!f)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">do</span> &#123;</span><br><span class="line">		start = fgets(<span class="keyword">buf</span>, sizeof(<span class="keyword">buf</span>), f);</span><br><span class="line">		<span class="keyword">if</span> (!start)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		len = strlen(start);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!tok)</span><br><span class="line">			tok = json_tokener_new();</span><br><span class="line"></span><br><span class="line">		obj = json_tokener_parse_ex(tok, start, len);</span><br><span class="line">		<span class="keyword">if</span> (obj) &#123;</span><br><span class="line">            <span class="comment">//注册脚本handler</span></span><br><span class="line">			netifd_init_script_handler(name, obj, cb);</span><br><span class="line">			json_object_put(obj);</span><br><span class="line">			json_tokener_free(tok);</span><br><span class="line">			tok = NULL;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (start[len - <span class="number">1</span>] == &#x27;\n&#x27;) &#123;</span><br><span class="line">			json_tokener_free(tok);</span><br><span class="line">			tok = NULL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">while</span> (!feof(f) &amp;&amp; !ferror(f));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tok)</span><br><span class="line">		json_tokener_free(tok);</span><br><span class="line"></span><br><span class="line">	pclose(f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">netifd_init_script_handler(<span class="keyword">const</span> char *script, json_object *obj, script_dump_cb cb)</span><br><span class="line">&#123;</span><br><span class="line">	json_object *tmp;</span><br><span class="line">	<span class="keyword">const</span> char *name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!json_check_type(obj, json_type_object))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	tmp = json_get_field(obj, <span class="string">&quot;name&quot;</span>, json_type_string);</span><br><span class="line">	<span class="keyword">if</span> (!tmp)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	name = json_object_get_string(tmp);</span><br><span class="line">    <span class="comment">//wireless_add_handler(&quot;mac80211.sh&quot;, &quot;mac80211&quot;, obj)</span></span><br><span class="line">	cb(script, name, obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* wireless netifd script handler */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">wireless_add_handler(<span class="keyword">const</span> char *script, <span class="keyword">const</span> char *name, json_object *obj)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">struct</span> wireless_driver *drv;</span><br><span class="line">	char *name_str, *script_str;</span><br><span class="line">	json_object *dev_config_obj, *iface_config_obj, *vlan_config_obj, *station_config_obj;</span><br><span class="line">	<span class="keyword">struct</span> uci_blob_param_list *dev_config, *iface_config, *vlan_config, *station_config;</span><br><span class="line"></span><br><span class="line">	dev_config_obj = json_get_field(obj, <span class="string">&quot;device&quot;</span>, json_type_array);</span><br><span class="line">	iface_config_obj = json_get_field(obj, <span class="string">&quot;iface&quot;</span>, json_type_array);</span><br><span class="line">	vlan_config_obj = json_get_field(obj, <span class="string">&quot;vlan&quot;</span>, json_type_array);</span><br><span class="line">	station_config_obj = json_get_field(obj, <span class="string">&quot;station&quot;</span>, json_type_array);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!dev_config_obj || !iface_config_obj || !vlan_config_obj || !station_config_obj)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	drv = calloc_a(sizeof(*drv),</span><br><span class="line">		&amp;dev_config, sizeof(*dev_config) + sizeof(<span class="keyword">void</span> *),</span><br><span class="line">		&amp;iface_config, sizeof(*iface_config) + sizeof(<span class="keyword">void</span> *),</span><br><span class="line">		&amp;vlan_config, sizeof(*vlan_config) + sizeof(<span class="keyword">void</span> *),</span><br><span class="line">		&amp;station_config, sizeof(*station_config) + sizeof(<span class="keyword">void</span> *),</span><br><span class="line">		&amp;name_str, strlen(name) + <span class="number">1</span>,</span><br><span class="line">		&amp;script_str, strlen(script) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	drv-&gt;name = strcpy(name_str, name);</span><br><span class="line">	drv-&gt;script = strcpy(script_str, script);</span><br><span class="line"></span><br><span class="line">	dev_config-&gt;n_next = <span class="number">1</span>;</span><br><span class="line">	dev_config-&gt;next[<span class="number">0</span>] = &amp;wdev_param;</span><br><span class="line">	drv-&gt;device<span class="variable">.config</span> = dev_config;</span><br><span class="line"></span><br><span class="line">	iface_config-&gt;n_next = <span class="number">1</span>;</span><br><span class="line">	iface_config-&gt;next[<span class="number">0</span>] = &amp;vif_param;</span><br><span class="line">	drv-&gt;<span class="keyword">interface</span><span class="variable">.config</span> = iface_config;</span><br><span class="line"></span><br><span class="line">	vlan_config-&gt;n_next = <span class="number">1</span>;</span><br><span class="line">	vlan_config-&gt;next[<span class="number">0</span>] = &amp;vlan_param;</span><br><span class="line">	drv-&gt;vlan<span class="variable">.config</span> = vlan_config;</span><br><span class="line"></span><br><span class="line">	station_config-&gt;n_next = <span class="number">1</span>;</span><br><span class="line">	station_config-&gt;next[<span class="number">0</span>] = &amp;station_param;</span><br><span class="line">	drv-&gt;station<span class="variable">.config</span> = station_config;</span><br><span class="line"></span><br><span class="line">	drv-&gt;device<span class="variable">.buf</span> = netifd_handler_parse_config(drv-&gt;device<span class="variable">.config</span>, dev_config_obj);</span><br><span class="line">	drv-&gt;<span class="keyword">interface</span><span class="variable">.buf</span> = netifd_handler_parse_config(drv-&gt;<span class="keyword">interface</span><span class="variable">.config</span>, iface_config_obj);</span><br><span class="line">	drv-&gt;vlan<span class="variable">.buf</span> = netifd_handler_parse_config(drv-&gt;vlan<span class="variable">.config</span>, vlan_config_obj);</span><br><span class="line">	drv-&gt;station<span class="variable">.buf</span> = netifd_handler_parse_config(drv-&gt;station<span class="variable">.config</span>, station_config_obj);</span><br><span class="line"></span><br><span class="line">	drv-&gt;node<span class="variable">.key</span> = drv-&gt;name;</span><br><span class="line">	avl_insert(&amp;wireless_drivers, &amp;drv-&gt;node);</span><br><span class="line">   <span class="comment">//daemon.err netifd[817]: wireless_add_handler(816): Add handler for script ./mac80211.sh: mac80211</span></span><br><span class="line">	D(WIRELESS, <span class="string">&quot;Add handler for script %s: %s&quot;</span>, script, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>命令<code>mac80211.sh dump</code>流程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mac80211.sh dump</span><br><span class="line">	-&gt;init_wireless_driver &#x27;&#x27; dump</span><br><span class="line">		-&gt; 重定义add_driver()函数</span><br><span class="line">	-&gt;add_driver mac80211</span><br><span class="line">		-&gt;drv_mac80211_cleanup</span><br><span class="line">		-&gt;drv_mac80211_init_device_config</span><br><span class="line">		-&gt;drv_mac80211_init_iface_config</span><br><span class="line">		-&gt;drv_mac80211_vlan_config</span><br><span class="line">		-&gt;drv_mac80211_init_station_config</span><br></pre></td></tr></table></figure>



<p><code>config_init_all</code>函数的作用 ???</p>
<h2 id="开关wifi流程"><a href="#开关wifi流程" class="headerlink" title="开关wifi流程"></a>开关wifi流程</h2><p>openwrt提供的开关wifi的命令是<code>wifi up/down &lt;interface&gt;</code>。相关代码在<code>/sbin/wifi</code>中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/sbin/wifi up/down $&#123;interface&#125;</span><br><span class="line">	-&gt;wifi_updown up/down $&#123;interface&#125;</span><br><span class="line">		-&gt;ubus_wifi_cmd $&#123;cmd&#125; $&#123;interface&#125;</span><br><span class="line">			-&gt; ubus call network.wireless &quot;$cmd&quot; &quot;$(json_dump)&quot;</span><br></pre></td></tr></table></figure>

<p><code>ubus call network.wireless up/down</code>会调用netifd中的netifd_handle_wdev_up或netifd_handle_wdev_down。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ubus_method</span> <span class="title">wireless_object_methods</span>[] =</span> &#123;</span><br><span class="line">	&#123; .name = <span class="string">&quot;up&quot;</span>, .handler = netifd_handle_wdev_up &#125;,</span><br><span class="line">	&#123; .name = <span class="string">&quot;down&quot;</span>, .handler = netifd_handle_wdev_down &#125;,</span><br><span class="line">	&#123; .name = <span class="string">&quot;reconf&quot;</span>, .handler = netifd_handle_wdev_reconf &#125;,</span><br><span class="line">	&#123; .name = <span class="string">&quot;status&quot;</span>, .handler = netifd_handle_wdev_status &#125;,</span><br><span class="line">	&#123; .name = <span class="string">&quot;notify&quot;</span>, .handler = netifd_handle_wdev_notify &#125;,</span><br><span class="line">	&#123; .name = <span class="string">&quot;get_validate&quot;</span>, .handler = netifd_handle_wdev_get_validate &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">wireless_device_set_up</span><br><span class="line">    -&gt;__wireless_device_set_up</span><br><span class="line">    	-&gt;wireless_device_run_handler</span><br><span class="line">    		-&gt;netifd_start_process</span><br><span class="line">    			-&gt; ./mac80211.sh mac80211 setup radio0 &#123;<span class="string">&quot;config&quot;</span>:&#123;<span class="string">&quot;channel&quot;</span>:<span class="string">&quot;11&quot;</span>,<span class="string">&quot;hwmode&quot;</span>:<span class="string">&quot;11g&quot;</span>,<span class="string">&quot;path&quot;</span>:<span class="string">&quot;platform\/10300000.wmac&quot;</span>,<span class="string">&quot;htmode&quot;</span>:<span class="string">&quot;HT20&quot;</span>,<span class="string">&quot;disabled&quot;</span>:<span class="literal">false</span>&#125;,<span class="string">&quot;interfaces&quot;</span>:&#123;<span class="string">&quot;0&quot;</span>:&#123;<span class="string">&quot;bridge&quot;</span>:<span class="string">&quot;br-lan&quot;</span>,<span class="string">&quot;config&quot;</span>:&#123;<span class="string">&quot;mode&quot;</span>:<span class="string">&quot;ap&quot;</span>,<span class="string">&quot;ssid&quot;</span>:<span class="string">&quot;OpenWrt&quot;</span>,<span class="string">&quot;encryption&quot;</span>:<span class="string">&quot;none&quot;</span>,<span class="string">&quot;network&quot;</span>:[<span class="string">&quot;lan&quot;</span>],<span class="string">&quot;mode&quot;</span>:<span class="string">&quot;ap&quot;</span>&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>



<p>mac80211.sh中<code>mac80211.sh setup</code>流程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mac80211.sh setup</span><br><span class="line">	-&gt;init_wireless_driver &#x27;&#x27; setup</span><br><span class="line">		-&gt; 重定义add_driver()函数</span><br><span class="line">	-&gt;add_driver mac80211</span><br><span class="line">		-&gt;_wdev_handler mac80211 setup $&#123;interface&#125;</span><br><span class="line">			-&gt;drv_mac80211_setup $&#123;interface&#125;</span><br><span class="line">				-&gt;wireless_set_up</span><br><span class="line">					-&gt;_wdev_notify_init</span><br><span class="line">					-&gt;_wdev_notify</span><br><span class="line">						-&gt;ubus $options call network.wireless notify &quot;$(json_dump)&quot;</span><br></pre></td></tr></table></figure>



<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">_wdev_notify_init() &#123;</span><br><span class="line">	local command=&quot;$1&quot;; shift;</span><br><span class="line"></span><br><span class="line">	json_init</span><br><span class="line">	json_add_int &quot;command&quot; &quot;$command&quot;</span><br><span class="line">	json_add_string &quot;device&quot; &quot;$__netifd_device&quot;</span><br><span class="line">	while [ -n &quot;$1&quot; ]; do</span><br><span class="line">		local name=&quot;$1&quot;; shift</span><br><span class="line">		local value=&quot;$1&quot;; shift</span><br><span class="line">		json_add_string &quot;$name&quot; &quot;$value&quot;</span><br><span class="line">	done</span><br><span class="line">	json_add_object &quot;data&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_wdev_notify() &#123;</span><br><span class="line">	local options=&quot;$1&quot;</span><br><span class="line"></span><br><span class="line">	json_close_object</span><br><span class="line">	ubus $options call network.wireless notify &quot;$(json_dump)&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">wireless_start_pending</span><br><span class="line">__wireless_start_pending</span><br><span class="line">wdev_set_config_state</span><br><span class="line">wdev_handle_config_change</span><br><span class="line">	-&gt;__wireless_device_set_up</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">wdev_handle_config_change</span><span class="params">(<span class="keyword">struct</span> wireless_device *wdev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">interface_config_state</span> <span class="title">state</span> =</span> wdev-&gt;config_state;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span>(state) &#123;</span><br><span class="line">	<span class="keyword">case</span> IFC_RELOAD:</span><br><span class="line">		wdev-&gt;retry = WIRELESS_SETUP_RETRY;</span><br><span class="line">		wdev-&gt;retry_setup_failed = <span class="literal">false</span>;</span><br><span class="line">		fallthrough;</span><br><span class="line">	<span class="keyword">case</span> IFC_NORMAL:</span><br><span class="line">		__wireless_device_set_up(wdev, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		wdev-&gt;config_state = IFC_NORMAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> IFC_REMOVE:</span><br><span class="line">		wireless_device_free(wdev);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="设置BSSID的流程"><a href="#设置BSSID的流程" class="headerlink" title="设置BSSID的流程"></a>设置BSSID的流程</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">mac80211_prepare_vif() &#123;</span><br><span class="line">	json_select config</span><br><span class="line"></span><br><span class="line">	json_get_vars ifname mode ssid wds powersave macaddr enable wpa_psk_file vlan_file</span><br><span class="line"></span><br><span class="line">	[ -n &quot;$ifname&quot; ] || &#123;</span><br><span class="line">		local prefix;</span><br><span class="line"></span><br><span class="line">		case &quot;$mode&quot; in</span><br><span class="line">		ap|sta|mesh) prefix=$mode;;</span><br><span class="line">		adhoc) prefix=ibss;;</span><br><span class="line">		monitor) prefix=mon;;</span><br><span class="line">		esac</span><br><span class="line"></span><br><span class="line">		mac80211_set_ifname &quot;$phy&quot; &quot;$prefix&quot;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	append active_ifnames &quot;$ifname&quot;</span><br><span class="line">	set_default wds 0</span><br><span class="line">	set_default powersave 0</span><br><span class="line">	json_add_string _ifname &quot;$ifname&quot;</span><br><span class="line"></span><br><span class="line">	default_macaddr=</span><br><span class="line">	if [ -z &quot;$macaddr&quot; ]; then</span><br><span class="line">		macaddr=&quot;$(mac80211_generate_mac $phy)&quot;</span><br><span class="line">		macidx=&quot;$(($macidx + 1))&quot;</span><br><span class="line">		default_macaddr=1</span><br><span class="line">	elif [ &quot;$macaddr&quot; = &#x27;random&#x27; ]; then</span><br><span class="line">		macaddr=&quot;$(macaddr_random)&quot;</span><br><span class="line">	fi</span><br><span class="line">	json_add_string _macaddr &quot;$macaddr&quot;</span><br><span class="line">	json_add_string _default_macaddr &quot;$default_macaddr&quot;</span><br><span class="line">	json_select ..</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	[ &quot;$mode&quot; == &quot;ap&quot; ] &amp;&amp; &#123;</span><br><span class="line">		[ -z &quot;$wpa_psk_file&quot; ] &amp;&amp; hostapd_set_psk &quot;$ifname&quot;</span><br><span class="line">		[ -z &quot;$vlan_file&quot; ] &amp;&amp; hostapd_set_vlan &quot;$ifname&quot;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	json_select config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">	# </span><span class="language-bash">It is far easier to delete and create the desired interface</span></span><br><span class="line">	case &quot;$mode&quot; in</span><br><span class="line">		ap)</span><br><span class="line"><span class="meta prompt_">			# </span><span class="language-bash">Hostapd will handle recreating the interface and</span></span><br><span class="line"><span class="meta prompt_">			# </span><span class="language-bash">subsequent virtual APs belonging to the same PHY</span></span><br><span class="line">			if [ -n &quot;$hostapd_ctrl&quot; ]; then</span><br><span class="line">				type=bss</span><br><span class="line">			else</span><br><span class="line">				type=interface</span><br><span class="line">			fi</span><br><span class="line"></span><br><span class="line">			mac80211_hostapd_setup_bss &quot;$phy&quot; &quot;$ifname&quot; &quot;$macaddr&quot; &quot;$type&quot; || return</span><br><span class="line"></span><br><span class="line">			[ -n &quot;$hostapd_ctrl&quot; ] || &#123;</span><br><span class="line">				ap_ifname=&quot;$&#123;ifname&#125;&quot;</span><br><span class="line">				hostapd_ctrl=&quot;$&#123;hostapd_ctrl:-/var/run/hostapd/$ifname&#125;&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		;;</span><br><span class="line">	esac</span><br><span class="line"></span><br><span class="line">	json_select ..</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mac80211_hostapd_setup_bss() &#123;</span><br><span class="line">	local phy=&quot;$1&quot;</span><br><span class="line">	local ifname=&quot;$2&quot;</span><br><span class="line">	local macaddr=&quot;$3&quot;</span><br><span class="line">	local type=&quot;$4&quot;</span><br><span class="line"></span><br><span class="line">	hostapd_cfg=</span><br><span class="line">	append hostapd_cfg &quot;$type=$ifname&quot; &quot;$N&quot;</span><br><span class="line"></span><br><span class="line">	hostapd_set_bss_options hostapd_cfg &quot;$phy&quot; &quot;$vif&quot; || return 1</span><br><span class="line">	json_get_vars wds wds_bridge dtim_period max_listen_int start_disabled</span><br><span class="line"></span><br><span class="line">	set_default wds 0</span><br><span class="line">	set_default start_disabled 0</span><br><span class="line"></span><br><span class="line">	[ &quot;$wds&quot; -gt 0 ] &amp;&amp; &#123;</span><br><span class="line">		append hostapd_cfg &quot;wds_sta=1&quot; &quot;$N&quot;</span><br><span class="line">		[ -n &quot;$wds_bridge&quot; ] &amp;&amp; append hostapd_cfg &quot;wds_bridge=$wds_bridge&quot; &quot;$N&quot;</span><br><span class="line">	&#125;</span><br><span class="line">	[ &quot;$staidx&quot; -gt 0 -o &quot;$start_disabled&quot; -eq 1 ] &amp;&amp; append hostapd_cfg &quot;start_disabled=1&quot; &quot;$N&quot;</span><br><span class="line"></span><br><span class="line">	cat &gt;&gt; /var/run/hostapd-$phy.conf &lt;&lt;EOF</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">hostapd_cfg</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bssid来自macaddr</span></span><br><span class="line">bssid=$macaddr</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;default_macaddr:+#default_macaddr&#125;</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;dtim_period:+dtim_period=<span class="variable">$dtim_period</span>&#125;</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">&#123;max_listen_int:+max_listen_interval=<span class="variable">$max_listen_int</span>&#125;</span></span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ol>
<li><a target="_blank" rel="noopener" href="https://vonger.cn/?m=20180505">https://vonger.cn/?m=20180505</a></li>
<li><a target="_blank" rel="noopener" href="https://openwrt.org/docs/techref/netifd">https://openwrt.org/docs/techref/netifd</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.chinaunix.net/uid-27057175-id-4881960.html">http://blog.chinaunix.net/uid-27057175-id-4881960.html</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://muyexinya.github.io/2024/11/16/openwrt-wifi%E5%BC%80%E5%85%B3%E5%92%8C%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B/" data-id="cm9e0dyaz0005m0v776qxd7ni" data-title="openwrt_wifi开关和配置流程" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2025/04/12/Wi-Fi%20%E7%9A%84AP%E9%9A%94%E7%A6%BB%E5%8A%9F%E8%83%BD/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          Wi-Fi的AP隔离功能的实现
        
      </div>
    </a>
  
  
    <a href="/2024/09/28/Memory-Barriers/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">Memory-Barriers</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Wi-Fi/" rel="tag">Wi-Fi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Wi-Fi/" style="font-size: 10px;">Wi-Fi</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">操作系统</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">April 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/04/12/Wi-Fi%20%E7%9A%84AP%E9%9A%94%E7%A6%BB%E5%8A%9F%E8%83%BD/">Wi-Fi的AP隔离功能的实现</a>
          </li>
        
          <li>
            <a href="/2024/11/16/openwrt-wifi%E5%BC%80%E5%85%B3%E5%92%8C%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B/">openwrt_wifi开关和配置流程</a>
          </li>
        
          <li>
            <a href="/2024/09/28/Memory-Barriers/">Memory-Barriers</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 muyexinya@163.com<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>